@{
    Layout = "_LayoutCategory";

    // Lấy state hiện tại từ query string
    var currentQuery = ViewContext?.HttpContext?.Request?.Query["query"].ToString();
    var currentSort  = ViewContext?.HttpContext?.Request?.Query["sort"].ToString();
    var currentLoai  = ViewContext?.HttpContext?.Request?.Query["loai"].ToString(); // nếu có lọc theo loại
}

<!-- Single Page Header start -->
@RenderSection("BredCum", required: false)
<!-- Single Page Header End -->
<!-- Fruits Shop Start-->
<div class="container-fluid fruite py-5">
    <div class="container py-5">
        <h1 class="mb-4">Ecommerce</h1>
        <div class="row g-4">
            <div class="col-lg-12">
                <div class="row g-4">

                    <!-- SEARCH -->
                    <div class="col-xl-3">
                        <div class="input-group w-100 mx-auto d-flex">
                            <form asp-action="Search" asp-controller="HangHoa" method="get" class="d-flex w-100">
                                <input type="search"
                                       class="form-control p-3"
                                       placeholder="keywords"
                                       aria-describedby="search-icon-1"
                                       name="query"
                                       value="@(currentQuery)" />
                                <!-- Giữ sort & loai khi bấm search -->
                                <input type="hidden" name="sort" value="@(currentSort)" />
                                @* Nếu bạn có tham số loai *@
                                @if (!string.IsNullOrEmpty(currentLoai))
                                {
                                    <input type="hidden" name="loai" value="@(currentLoai)" />
                                }
                                <button type="submit" class="btn btn-light">
                                    <span id="search-icon-1" class="input-group-text p-3">
                                        <i class="fa fa-search"></i>
                                    </span>
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="col-6"></div>

                    <!-- SORT -->
                    <div class="col-xl-3">
                        <div class="bg-light ps-3 py-3 rounded d-flex justify-content-between mb-4 align-items-center">
                            <label for="sort" class="mb-0 me-2">Sắp xếp:</label>

                            <!-- Form GET riêng cho sort, auto-submit khi đổi -->
                            <form id="sortForm" asp-action="Index" asp-controller="HangHoa" method="get" class="d-flex">
                                <!-- Giữ query & loai khi đổi sort -->
                                <input type="hidden" name="query" value="@(currentQuery)" />
                                @if (!string.IsNullOrEmpty(currentLoai))
                                {
                                    <input type="hidden" name="loai" value="@(currentLoai)" />
                                }

                                <select id="sort" name="sort" class="border-0 form-select-sm bg-light me-3"
                                        onchange="document.getElementById('sortForm').submit()">
                                    <option value="" selected="@(string.IsNullOrEmpty(currentSort))">Mặc định</option>
                                    <option value="price_asc" selected="@(currentSort == "price_asc")">Giá: Thấp → Cao</option>
                                    <option value="price_desc" selected="@(currentSort == "price_desc")">Giá: Cao → Thấp</option>
                                </select>

                            </form>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-lg-3">
                        <div class="row g-4">
                            @await Component.InvokeAsync("MenuLoai")
                            <!-- các block khác giữ nguyên -->
                        </div>
                    </div>

                    <div class="col-lg-9">
                        <div class="row g-4 justify-content-center">
                            @RenderBody()
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
<!-- Fruits Shop End-->
